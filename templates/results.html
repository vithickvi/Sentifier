<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta charset="utf-8">
		<title>Sentifier</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link href="/static/css/bootstrap.min.css" rel="stylesheet">
		<link href="/static/css/styles.css" rel="stylesheet">
		<script src="/static/js/jquery.js"></script>
		<script src="/static/js/bootstrap.min.js"></script>
		<script src="http://maps.googleapis.com/maps/api/js?sensor=false&extension=.js&output=embed"></script>
		<script>
		var cnt=5;
		var cntmax=6;
		
		var markerMap = {};
		$(document).ready(function(){
			$('#search').val(window.localStorage.getItem("searchvalue"));			
			google.maps.event.addDomListener(window, 'load', gettweets);
		});
		function moretweets()
		{
			cntmax=cntmax+5;
			gettweets();
		}
		
		function gettweets()
		{
			$('#divLoading').css('display','block');
			$('#overlay').css('opacity','0.5');
			
			
			var settweet=""
			cnt=cnt+5;
			$.ajax({
				  url: "/fetchresults/",
				  type: "POST",
				  async: false,
				  dataType: 'json',
				  data: {csrfmiddlewaretoken: '{{ csrf_token }}',value:$('#search').val(),count:cnt},
				  success: function(data) {

					$('#headcnt').html(data.result.length+" tweets found");
					var map = new google.maps.Map(document.getElementById('map-canvas'), { zoom: 2, center: new google.maps.LatLng(13.92, 1.25), mapTypeId: google.maps.MapTypeId.ROADMAP    });    
					var infowindow = new google.maps.InfoWindow();    
					
					$.each(data.result, function(k, v) {

						var myLatlng = new google.maps.LatLng(parseFloat(v[2].split(",")[0]),parseFloat(parseFloat(v[2].split(",")[1])));
						settweet=settweet+"<p onclick='highlightmap("+k+")' style='color:"+v[1]+";'>"+v[0]+"</p><hr>"

						 var marker = new google.maps.Marker({position: myLatlng,map: map	});
						 markerMap[ "marker-" + k ] = marker;
						 marker.setIcon('http://maps.google.com/mapfiles/ms/icons/'+v[1]+'-dot.png')      

						google.maps.event.addListener(marker, 'click', (function(marker, k) {        return function() {  
							infowindow.setContent(v[0]);						   
							infowindow.open(map, marker);      
						  }   
						  })
						  (marker,k)); 


					});
					$('#tweetlist').html(settweet);
					/*if (cnt < cntmax)
						setTimeout(gettweets,5000);*/
				  }
					
				});
			$('#overlay').css('opacity','100');
			$('#overlay').css('background-color','#fff');
			$('#divLoading').css('display','none');
		}
		function highlightmap(id)
		{		
			google.maps.event.trigger(markerMap["marker-"+id], "click");
		}
		
		</script>
	</head>
	<body>

<div class="navbar navbar-custom navbar-fixed-top">
 <div class="navbar-header"><a class="navbar-brand" href="/index/">Sentifier</a>
      
    </div>
    <div class="navbar-collapse collapse">
    
      <form class="navbar-form">
        <div class="form-group" style="display:inline;">
          <div class="input-group">
           
            <input id="search" type="text" class="form-control" placeholder="What are searching for?">
            <span onclick="gettweets();return false;" class="input-group-addon"><span class="glyphicon glyphicon-search" ></span> </span>
          </div>
        </div>
      </form>
    </div>
</div>

<div id="overlay">
<div id="divLoading" style="display:none;">
<img src="/static/img/gears.gif" alt="Loading...." style="width:152px;height:152px;">
</div>

<div class="container-fluid" id="main">
  <div class="row">
  	<div class="col-xs-8" id="left" style="width:30%;overflow:auto;">
    
      <h2 id="headcnt" style="margin-top:60px;"></h2>
     
      <!-- item list -->
      <div class="panel panel-default">
        <div class="panel-heading"><a href="">Tweets</a></div>
      </div>
	  <div id="tweetlist">
      </div>     
      <p>
      <a href="#" onclick="moretweets();return false;" class="center-block btn btn-primary">More..</a>
      </p>
    </div>
	<div style="height:100%;">
	<div id="map-canvas"></div>
	<div id="charts">
	Hello Hello Hello
	</div>
	</div>
  

    
	</div>
</div>

</div>	


	</body>
</html>